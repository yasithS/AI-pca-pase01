<!doctype html>
<html>
  <head>
  <title>Browse Google Drive / Picker</title>

  <!-- 1) Define all callbacks BEFORE we load any GAPI scripts -->
  <script>
    const API_KEY   = 'AIzaSyDs7gZLYgDfoiavb7WR1kUAaSZLx_tYQNg';
    const CLIENT_ID = '112348270409-55f094s7kst4nv6p4qdanolpotnlcfau.apps.googleusercontent.com';
    const SCOPE     = 'https://www.googleapis.com/auth/drive.readonly';

    let oauthToken     = null;
    let gapiInited     = false;
    let pickerApiLoaded= false;

    function onGapiLoad() {
      gapi.client
         .init({
           apiKey: API_KEY,
           discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
         })
         .then(() => {
           console.log('✅ GAPI initialized');
           gapiInited = true;
         })
         .catch(e => console.error('GAPI init error', e));
    }

    function onPickerApiLoad() {
      console.log('✅ Picker API loaded');
      pickerApiLoaded = true;
    }

    function loadApis() {
      // NOTE: drop the old auth2 module
      gapi.load('client', { callback: onGapiLoad });
      gapi.load('picker', { callback: onPickerApiLoad });
    }

    async function fetchOAuthToken() {
      const res = await fetch('/picker_token');
      if (!res.ok) throw new Error('Not signed in');
      oauthToken = (await res.json()).token;
    }

    async function openPicker() {
      if (!gapiInited || !pickerApiLoaded) {
        return alert('APIs not loaded yet. Check console.');
      }
      await fetchOAuthToken();

      const view = new google.picker.DocsView(google.picker.ViewId.SPREADSHEETS)
        .setIncludeFolders(true)
        .setSelectFolderEnabled(false)
        .setMimeTypes('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');

      new google.picker.PickerBuilder()
        .setAppId('112348270409')
        .addView(view)
        .setDeveloperKey(API_KEY)
        .setOAuthToken(oauthToken)
        .setCallback(pickerCallback)
        .build()
        .setVisible(true);
    }

    function pickerCallback(data) {
      if (data.action === google.picker.Action.PICKED) {
        const fileId = data.docs[0].id;
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/select_drive_file';
        form.innerHTML = `<input type="hidden" name="file_id" value="${fileId}">`;
        document.body.appendChild(form);
        form.submit();
      }
    }
  </script>

  <!-- 2) Load the Google APIs once, pointing at our loadApis() entrypoint -->
  <script src="https://apis.google.com/js/api.js?onload=loadApis"></script>
  <!-- 3) Then load the Picker UI code -->
  <script src="https://apis.google.com/js/picker.js"></script>
    </head>


  <body>
    <h2>Browse Google Drive</h2>
    <button onclick="openPicker()">Open Google Picker</button>
    <hr>

  </body>
</html>
